---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  chart:
    spec:
      version: ">=14.3.0"
  values:
    commonLabels:
      tier: cluster
    kubeControllerManager:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeProxy:
     enabled: false
    grafana:
      podLabels:
        app: grafana
      service:
        labels:
          app: grafana
      grafana.ini:
        server:
          root_url: http://grafana.demo.lab
      additionalDataSources:
        - name: Tempo
          type: tempo
          access: proxy
          uid: tempo_ds
          url: http://tempo:16686
        - name: Loki
          type: loki
          access: proxy
          uid: loki_ds
          url: http://loki-stack:3100
          jsonData:
            maxLines: 1000
            derivedFields:
              - datasourceUid: tempo_ds
                matchrRegex: "traceID=(\\w+)"
                name: TraceID
                url: "$${__value.raw}"
      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: true
            editable: false
            options:
              path: /var/lib/grafana/dashboards/default
      dashboards:
        default:
          flux-cluster:
            url: https://raw.githubusercontent.com/fluxcd/flux2/main/manifests/monitoring/grafana/dashboards/cluster.json
            token: ''
          flux-control-plane:
            url: https://raw.githubusercontent.com/fluxcd/flux2/main/manifests/monitoring/grafana/dashboards/control-plane.json
            token: ''
    alertmanager:
      alertmanagerSpec:
        externalUrl: http://alertmanager.demo.lab
    prometheus:
      prometheusSpec:
        externalLabels:
          cluster: demolab
          environment: staging
        externalUrl: http://prometheus.demo.lab
        ruleSelector:
          matchLabels:
            tier: cluster
        serviceMonitorSelector:
          matchLabels:
            tier: cluster
        additionalScrapeConfigs:
          - job_name: 'istiod'
            kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                - istio-system
            relabel_configs:
            - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
              action: keep
              regex: istiod;http-monitoring
          - job_name: 'envoy-stats'
            metrics_path: /stats/prometheus
            kubernetes_sd_configs:
            - role: pod
            relabel_configs:
            - source_labels: [__meta_kubernetes_pod_container_port_name]
              action: keep
              regex: '.*-envoy-prom'
      additionalPodMonitors:
        - name: source-controller
          additionalLabels:
            tier: cluster
          selector:
            matchLabels:
              app: source-controller
          namespaceSelector:
            matchNames:
              - flux-system
          podMetricsEndpoints:
            - port: http-prom
        - name: kustomize-controller
          additionalLabels:
            tier: cluster
          selector:
            matchLabels:
              app: kustomize-controller
          namespaceSelector:
            matchNames:
              - flux-system
          podMetricsEndpoints:
            - port: http-prom
        - name: helm-controller
          additionalLabels:
            tier: cluster
          selector:
            matchLabels:
              app: helm-controller
          namespaceSelector:
            matchNames:
              - flux-system
          podMetricsEndpoints:
            - port: http-prom
        - name: notification-controller
          additionalLabels:
            tier: cluster
          selector:
            matchLabels:
              app: notification-controller
          namespaceSelector:
            matchNames:
              - flux-system
          podMetricsEndpoints:
            - port: http-prom
#    prometheus:
#      annotations:
#        traffic.sidecar.istio.io/includeInboundPorts: ""   # do not intercept any inbound ports
#        traffic.sidecar.istio.io/includeOutboundIPRanges: ""  # do not intercept any outbound traffic
#        proxy.istio.io/config: |  # configure an env variable `OUTPUT_CERTS` to write certificates to the given folder
#          proxyMetadata:
#            OUTPUT_CERTS: /etc/istio-output-certs
#        sidecar.istio.io/userVolumeMount: '[{"name": "istio-certs", "mountPath": "/etc/istio-output-certs"}]' # mount the shared volume at sidecar proxy
#      prometheusSpec:
#        volumes:
#          - emptyDir:
#              medium: Memory
#            name: istio-certs
#        volumeMounts:
#          - mountPath: /etc/prom-certs/
#            name: istio-certs
##      serviceMonitor:
##        scheme: https
##        tlsConfig:
##          caFile: /etc/prom-certs/root-cert.pem
##          certFile: /etc/prom-certs/cert-chain.pem
##          keyFile: /etc/prom-certs/key.pem
##          insecureSkipVerify: true  # Prometheus does not support Istio security naming, thus skip verifying target pod ceritifcate
#